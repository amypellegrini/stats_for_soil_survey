---
title: Chapter 1 Introduction to R and RStudio
author: Stephen Roecker, Katey Yoast, and Skye Wills 
date: "Tuesday, February 24, 2015"
output:
  html_document:
    keep_md: yes
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
---

```{r, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE,  results = 'asis', eval=FALSE)

# load required packages
library(aqp)
library(soilDB)
library(lattice)
library(latticeExtra)

# modify ggplot2like latticeExtra theme
opar <- trellis.par.get()
trellis.par.set(theme = ggplot2like())
tpg <- trellis.par.get()
tpg$axis.line <-  list(alpha = 1, col = "#000000", lty = rep(1, 7), lwd = rep(0.2, 7))
tpg$strip.border <- list(alpha = 1, col = "#000000", lty = rep(1, 7), lwd = rep(0.2, 7))
trellis.par.set(tpg)
```

![](figure/logo.jpg)


# Introduction

R is a free, open-source software and programming language developed in 1995 at the University of Auckland as an environment for statistical computing and graphics [(Ikaha and Gentleman, 1996)](https://www.stat.auckland.ac.nz/~ihaka/downloads/R-paper.pdf). Since then R has become one of the dominant software environments for data analysis and is used by a variety of scientific disiplines, including soil science, ecology, and geoinformatics ([Envirometrics CRAN Task View](https://cran.r-project.org/web/views/Environmetrics.html); [Spatial CRAN Task View](https://cran.r-project.org/web/views/Spatial.html)). R is particularly popular for its graphical capabilities, but it is also prized it's GIS capabilities which make it relatively easy to generate raster-based models. More recently, R has also gained several packages which are designed specifically for analyzing soil data. While the vast majority of people use Microsoft Excel for data analysis, R offers numerous advantages, such as:

- reproducibility (numerous Excel horror stories of scientific studies gone wrong exist [TED Talk](https://www.youtube.com/watch?v=dXKbkpilQME))
- large community of users that contribute disipline specific functionality, including soil science and ecology

While some people find the use of a commandline environment daunting, it is becoming a necessary skill for scientists as the volume and variety of data has grown. Thus scripting or programming has become a third language for many scientists, in addition to their native language and disipline specific terminology. Other popular programming languages include: Python, JavaScript, and SQL. 

```{r, echo=FALSE, eval=TRUE}

# fetch all KSSL data 'correlated as' Hartleton from the December 2015 snapshot
# details on the data processing: https://github.com/dylanbeaudette/process-kssl-snapshot
pedons <- fetchKSSL(series='Hartleton') 

# slab() is used to aggregate selected variables within a collections of soil profiles along depth-slices; in this example we are aggregating clay, sand, and organic carbon
s <- slab(pedons, taxonname ~ clay + sand + oc, slab.structure = 5)

#specify color and line width to be used in plot
tps <- list(superpose.line=list(col='black', lwd=2)) 

# slice-wise median and 25th/75th percentiles are reasonable estimations of central tendency and spread
xyplot(top ~ p.q50 | variable, data = s,
       layout = c(3, 1), ylim = c(105, -5), 
       scales = list(x = list(relation = 'free')),
       ylab='Depth', xlab='median bounded by 25th and 75th percentiles',
       lower=s$p.q25, upper=s$p.q75, cf=s$contributing_fraction,
       alpha=0.25, sync.colors=TRUE,
       panel = panel.depth_function, 
       prepanel = prepanel.depth_function,
       par.settings = tps
       )

# default plot method for SoilProfileCollection objects
# plot(pedons, name='hzn_desgn', cex.names=0.85, axis.line.offset=-4, color='clay')
``` 


# RStudio

RStudio is an integrated development environment (IDE) that allows you to interact with R more readily. RStudio is similar to the RGui, but is considerably more user friendly. It has more drop-down menus, windows with multiple tabs, and customization options. The first time you open RStudio, you will see three windows. A forth window is hidden by default, but can be used to view text files by clicking the **File** drop-down menu, then **New File,** and then **R Script.**.

RStudio Windows / Tabs  | Location    | Description                     |
------------------------|-------------|---------------------------------|
Console Window          | lower-left  | location were commands are entered and the output is printed |
Source Tabs             | upper-left  | built-in text editor |
Environment Tab         | upper-left  | interactive list of loaded R objects |
History Tab             | upper-left  | list of key strokes entered into the Console |
Files Tab               | lower-right | file explorer to navigate windows folders |
Plots Tab               | lower-right | output location for plots  |
Packages Tab            | lower-right | list of packages and links to package specific help files |
Help Tab                | lower-right | output location for help commands and help search window |
Viewer Tab              | lower-right | advanced tab for local web content |

![](figure/ch1_rstudio.png)  

For further information on how to use RStudio, visit: [Using RStudio](https://support.rstudio.com/hc/en-us/sections/200107586-Using-RStudio).

R and RStudio have been installed on all USDA computers which have NASIS installed. R and RStudio are typically updated and CCE-approved once a year. The versions on USDA machines may be one to three releases behind the latest version available for public download. Having an outdated version of R  rarely creates a problem, although warnings may appear.  

**Tips for using R:**  

- R is command-line driven. It requires you to type or copy-and-paste commands after a command prompt (>) that appears when you open R. After typing a command in the R console and pressing **Enter** on your keyboard, the command will run. If your command is not complete, R issues a continuation prompt (signified by a plus sign: `+`). Alternatively you can write a script in the script window, and select a command, and click the **Run** button. 

- R is case sensitive. Make sure your spelling and capitalization are correct.  
 
- Commands in R are also called functions. The basic format of a function in R is: `function.name(argument, options)`.  
 
- The up arrow (^) on your keyboard can be used to bring up previous commands that you've typed in the R console. 
 
- The `$` symbol is used to select a particular column within the table (e.g., `table$column`).

- Any text that you do not want R to act on (such as comments, notes, or instructions) needs to be preceded by the `#` symbol (a.k.a. hash-tag, comment, pound, or number symbol).  R ignores the remainder of the script line following `#`. For example:  
 
`plot(x, y) # This text will not affect the plot function because of the comment`

```{r, eval=TRUE}
# Simple examples
1 + 1

10 * 10

log10(100)

"Hello World"

hist(npk$yield)
```


## Data Management in RStudio  

Before you begin working in R, create a working directory (a folder) to hold all of your project files; for example, "C:\\workspace\\...". This directory is the location where all your input data-sets and R scripts are stored. It also serves as the default location for plots and other objects exported from R. If set, it conviently allows allows you to import data into R with just a file name, not an entire folder path and file name.

Typically at the beginning of each R session you should set your working directory. To change the working directory in RStudio, select the **Files Tab > More > Set As Working Directory**. 

![](figure/ch1_setwd.png)

This can be accomplished in the Console by typing:

```{r}
setwd("C:/workspace")

# beware R uses forward slashes / instead of back slashes \ for file path names
```

To check the file path of the current working directory (which should now be "C:\\workspace"), type:

```{r}
getwd()
```


### Importing Data

After your working directory is set, you can import data from .csv, .txt, etc. One basic command for importing data into R is `read.csv()`. The command is followed by the file name and then some optional instructions for how to read the file.    

First, create an example file by copying the contents below. Paste the content into Notepad and save the file as sand_example.csv in the C:\workspace folder.  

location,landuse,horizon,depth,sand  
city,crop,A,14,19  
city,crop,B,25,21  
city,pasture,A,10,23  
city,pasture,B,27,34  
city,range,A,15,22  
city,range,B,23,23  
farm,crop,A,12,31  
farm,crop,B,31,35  
farm,pasture,A,17,30  
farm,pasture,B,26,36  
farm,range,A,15,25  
farm,range,B,24,29  
west,crop,A,13,27  
west,crop,B,29,25  
west,pasture,A,11,21  
west,pasture,B,31,26  
west,range,A,14,23  
west,range,B,24,24  

This dataset can either be simply imported into R using the **Import Dataset** button from the Environment tab, or by typing the following command into the R console:  

```{r, eval=TRUE}
sand <- read.csv("C:/workspace/sand_example.csv") 

# if your workspace was already set you could simply use the filename, like so

# sand <-read.csv("sand_example.csv")
```


### Exporting Data

To export data from R, use the command `write.csv()`. Since we have already set our working directory, R automatically saves our file into the working directory.  

```{r}
write.csv(sand, file = "sand_example2.csv")

# or use the write.table() function to export other text file types
``` 


### Viewing Data

Once the file is imported, it is imperative that you check to ensure that R correctly imported your data. Make sure numerical data are correctly imported as numerical, that your column headings are preserved, etc. To view data simply **click** on the sand dataset listed in the Environment tab. This will open up a separate window that displays a spreadsheet like view.

![](figure/ch1_view_dataframe.png)


Additionally you can use the following functions to view your data in R.

Function  | Description                                         |
----------|-----------------------------------------------------|
`print()` | prints the entire object (avoid with large tables)  |
`head()`  | prints the first 6 lines of your data               |
`str()`   | shows the structure of the data object              |
`names()` | lists the column names (i.e., headers) of your data |
`ls()`    | lists the objects in your workspace                 |


Try entering the following commands to view your dataset in R: 

```{r}
str(sand)

names(sand)

head(sand)

ls()
``` 

A data object is anything you've created or imported and assigned a name to in R. The Environment tab allows you to see what data objects are in your R session and expand their structure. Right now sand should be the only data object listed. If you wanted to delete all data objects from your R session, you could **click the broom icon** from the Environments tab. Otherwise you could type:

```{r}
# Remove all R objects
rm(list = ls(all = TRUE)) 

# Remove individal objects
rm(sand)
```


![](figure/ch1_clear_workspace.png)


## Getting Help 

To learn more about the function you are using and the options and arguments available, take advantage of some of the following help functions in RStudio:

1. Use the Help tab in the lower right to search commands (such as hist) or objects (such as histogram). 
2. After typing a command (such as hist) in the Console window, place your cursor at the end of the function and press **F1** on your keyboard to bring up more information about the command. Information will appear under the Help tab on the lower right. 
3. Just as in R, you can type `?hist` in the Console window to bring up a help page. This is also displayed under the Help tab in the lower right. 
4. Finally, you can also search for help on any function (even if you don't have the package installed) by typing the following:  

Other arguments are available for use with `read.csv()`. A quick way to find out what arguments are available for a given command is to type `help(command)`. In this example, you would type:

```{r}
help(read.csv) 

# or

?read.csv
```

These help commands bring up a webpage that describes all of the possible arguments for a command. The help pages also typically provide examples. You should also notice by reading the help page for `read.csv()` that it is just one of several functions for reading text files.

```{r}
help.search("histogram")
``` 

![](figure/ch1_fig36_rgui.jpg)  

Look through the usage and arguments in the help documents. Re-enter the `hist` function; evaluate the effects of changing color, breaks, freq, and labels.  

```{r}
hist(sand$sand, freq=TRUE, breaks=12, xlim = c(15, 40), main = "Histogram of Sand", sub = "with 12 bins", col ="lightblue", ylab = "Counts", xlab = "Total Sand") 
```

Note how changing the breaks argument alters the appearance of the graph. The breaks argument specifies how the individual values should be counted in bins or groups. The xlim argument specifies where to set the upper and lower limits of the x-axis.  

Note that this arbitrarily sets the bin breaks using a list c(x1,x2,x3..). This can be a good way to separate groups, but it does so in a way that may alter the way you visualize the distribution. This will work for any function in the console command prompt. 

**Exercise**

Determine how you would change the chart title to "Histogram" and change the number of breaks (and therefore subtitles) to six bins. Plot and examine the results.


## Packages

Packages are collections of additional functions that can be loaded on demand. They commonly include example data that can be used to deomonstrate those functions. Although R comes with most common statistical functions and models, most of our work requires additional packages.

To use a package, you must install it and then load it. These steps can be done at the command line or using RGui. Examples of both are provided below. R packages only need to be installed once (until R is upgraded or re-installed). Every time you start a new R session, however, you need to load every package that you intend to use in that session.  

The Comprehensive R Archive Network (CRAN) is a collection of sites that carry identical material for R. Select the location closest to you. 

### Installing Packages

Within the RStudio lower-left hand window if can select the **Packages** tab. You will see a list of all the packages currently installed on your computer, and 2 buttons to labeled either "Install" or "Update". To install a new package simply select the **Install** button. You can enter more than one package to install at a time by separating them with a comma.   

![](figure/ch1_package_window.png)  

![](figure/ch1_install_example.png)


To find out what packages are installed on your computer, use the following commands:

```{r}
library() 

#or

installed.packages()
``` 

One extremely useful package is the soiltexture package, which as you would expect allows you to plot soil textural triangles. The following command shows how to install this package if you do not have currently have it downloaded:  

```{r}
install.packages("soiltexture", dep = TRUE) #dep=TRUE will install all packages that "soiltexture" depends on to work correctly
``` 


### Loading Packages

Once a package is installed, it must be loaded into the R session to be used. 

```{r, eval=TRUE}
library(soiltexture)
```

You can also install and load packages using the **Packages** drop-down menu. Documentation about the soiltexture package is available from the help functions in R. 

```{r}
help(package = "soiltexture")
``` 

This help command sends you to a webpage. Scroll down and select the link "TT.plot". This link brings up a webpage that has instructions on how to use the `TT.plot()` function in R. 

The basic usage of the `TT.plot()` function is: TT.plot(class.sys, tri.data). The "class.sym" argument specifies a character string naming the textural classificaiton system.

```{r, eval=TRUE, fig.width=8, fig.height=8}
# Copied from soiltexture vignette
# Create a dummy data frame of soil textures:
example <- data.frame(
"CLAY" = c(05,60,15,05,25,05,25,45,65,75,13,47),
"SILT" = c(05,08,15,25,55,85,65,45,15,15,17,43),
"SAND" = c(90,32,70,70,20,10,10,10,20,10,70,10),
"OC" = c(20,14,15,05,12,15,07,21,25,30,05,28)
) 

TT.plot( class.sys = "USDA.TT", tri.data = example)
```

Try some of the examples included in the [soiltexture vignette](http://cran.r-project.org/web/packages/soiltexture/vignettes/soiltexture_vignette.pdf).  


## Working with Scripts  

In RStudio, set your working directory to C:\workspace either by using the drop-down menus (Session, Set Working Directory, or Choose Directory) or by typing the following into the RStudio Console window and pressing **Enter**: 

```{r}
setwd("C:/workspace")
```

Next, open the script that you created in R commander and edited in R editor. You do this by navigating to the **File** menu, clicking **Open File,** and then selecting **sand_rcmdr.R.** Run commands from within the script by selecting the first command (first two lines of code) and clicking **Run** on the task bar above the script. 

![](figure/ch1_fig33_rgui.jpg)  

Note that the command line is passed to the console (lower left) and the data file appears in the workspace (upper right) as sand2. Click  the file name **sand2** under the **Environment** tab in the top left quadrant. Note that the console shows the corresponding command prompt > view(sand2).  

![](figure/ch1_fig34_rgui.jpg)

Switch back to the sand_rcmdr.R script window, select the command to create a histogram (begins with Hist), and click **Run.** You will get this error message: "Error: could not find function 'Hist.'" 

**What happened?**

The Hist function is only available through the Rcmdr package. Because Rcmdr is not loaded in RStudio, you cannot use the `Hist()` command unless you load Rcmdr (`library(Rcmdr)`). To use the `Hist` command without loading the Rcmdr package, go to the console, use the up arrow-key on your keyboard to edit the command so that it has a lowercase h as in hist, and then press the **Enter** key. Next, edit the Hist command in the R script; do the same for Boxplot (i.e., change to boxplot).  

![](figure/ch1_fig35_rgui.jpg)  

Select both commands (hist and boxplot) and click **Run** again. Ignore the warning message. You will see the most recent graph in the Plot window. Use the arrows to scroll through all graphs produced during this session. Save your script by clicking in the R script window and then clicking **File > Save As.** Name the file sand_studio.R.  


## Saving R Files  

In R, you can save several types of files to keep track of the work you do. The file types include: workspace, script, history, and graphics. It is important to save often because R, like any other software, may crash periodically. Such problems are especially likely when working with large files. You can save your workspace in R via the command line or the File menu.  

### Workspace (.Rdata)  

The R workspace consists of all the data objects you've created or loaded during your R session. When you quit R by either typing `q()` or exiting out of the application window, R will prompt you to save your workspace. If you choose yes, R saves a file named .RData to your working directory. The next time you open R and reload your .Rdata workspace, all of your data objects will be available in R and all of the commands that you've typed will be accessible by using the up-arrow and down-arrow keys on your keyboard. You can also save or load your workspace at any time during your R session by clicking the **File** menu.   

![](figure/ch1_fig11_rgui.jpg)  

![](figure/ch1_save_workspace.png)    

The R command for saving your workspace is:
```{r}
save.image(file="workspace.RData")
```


### R script (.R)

An R script is simply a text file of R commands that you've typed. 

You may want to save your scripts (whether they were written in R Editor or another program such as Notepad) so that you can reference them in the future, edit them as needed, and keep track of what you've done. To save R scripts in RStudio, simply **click the save button** from your R script tab. Save scripts with the .R extension. R assumes that script files are saved with only that extension. If you are using another text editor, you won't need to worry about saving your scripts in R. You can always copy them from your text editor and then paste them into the R Console or R Editor.  

![](figure/ch1_save_script.png)  

To open an R script, **click the file icon**.  

![](figure/ch1_file_icon.png)


### R history (.Rhistory) 

An R history file is a copy of all your key strokes. You can think of it as brute force way of saving your work. It can be useful if you didn't document all your steps in an R script file. Like an R file, an Rhistory file is simply a text file that lists all of the commands that you've executed. It does not keep a record of the results. To load or save your R history from the menu bar click **File** > **Load History** or **File** > **Save History.** If you load an Rhistory file, your previous commands will again become available with the up-arrow and down-arrow keys.

![](figure/ch1_fig15_rgui.jpg) 

You can also use the command line to load or save your history.  

```{r}
savehistory(file = "sand.Rhistory")  
loadhistory(file = "sand.Rhistory")  
history(max.show=Inf) #displays all previous commands
```

### R Graphics   

Graphic outputs can be saved in various formats. 
 
```{r, echo=FALSE, eval=TRUE}
library(knitr)
test <- data.frame(Function = c('pdf("graphic.pdf")', 'win.metafile("graphic.wmf")', 'png("graph.png")', 'jpeg("graph.jpg")', 'bmp("graph.bmp")', 'postscript("graph.ps")'), Output = c("pdf file", "window metafile", "png file", "jpeg file", "bmp file", "postscript file"))
kable(test)
```

To save a graphic: (1) Click in the **Graphics Device** window to bring it to focus, (2) click the **File** menu and then the **Save as** command, and (3) click the desired image format.  

![](figure/ch1_fig18_rgui.jpg)  

The R command for saving a graphic is:  

```{r, eval=TRUE}
png(file = "sand.png")
plot(sand$sand)
dev.off()
```

The first line of this command creates a blank file named sand with a JPEG extension.  The second line plots the data object that you want to create a graphic of (here it is conveniently the same name as the JPEG file we are creating). The third line closes the graphics device.  


# Rcmdr (R Commander): A Graphical User Interface for R

While we recommend the use of RStudio for some of the reasons listed above, many people new to R might benefit from a graphical user interface (GUI) that allows users to run basic functions using a point and click interface. Luckily for beginners R has the R Commander (Rcmdr) GUI, which is similiar to [JMP](https://www.jmp.com/en_us/learning-library/using-jmp.html). Rcmdr was created by [John Fox](http://socserv.socsci.mcmaster.ca/jfox/Misc/Rcmdr/index.html) for his introductory statistics students they could see how the software worked without learning a large number of command line scripts. Rcmdr is a great way to begin familiarizing yourself with R and statistics within a GUI environment. Regretable we know of no GUI that allows users to perform the majority of soil survey applications demonstrated in this course, and thus won't Rcmdr won't be covered. For those who wish to pursue Rcmdr, alternative instructions can be viewed at [Andy Chang & G. Jay Kerns website](http://gchang.people.ysu.edu/r/R_Instructions.htm).

To take a quick peak at Rcmdr, it can be loadeload by **entering** the following command into the R console.

```{r, echo=TRUE, eval=FALSE}
install.packages(Rcmdr)
library(Rcmdr)
```

![](figure/ch1_rcmdr.png)  

# Review

Given what you now know about R, try to answer the following questions:

1. How can the `str()` function be used?

2. What are packages?

3. Which R function is used to load packages?

4. What types of files can you save in R? 

5. What would be the result of `plot(clay ~ organiccarbon, data=KSSL)`?


# Additional Resources  
- [R Manuals](http://cran.r-project.org/manuals.html)
- [Comprehensive R Archive Network (CRAN) Task View](https://cran.r-project.org/web/views/)
- [Quick R](http://www.statmethods.net/)  
- [Algorithms for Quantitative Pedology and Working with NRCS soil databases](http://ncss-tech.github.io/AQP/)
- [California Soil Resource Lab](http://casoilresource.lawr.ucdavis.edu/software/r-advanced-statistical-package/)
- [David Rossiter's R Applications and Lecture Notes](http://www.css.cornell.edu/faculty/dgr2/)
- [R for Digital Soil Mapping by Brendan Malone](http://www.clw.csiro.au/aclep/documents/DSM%20Workshop%20Manual.pdf)
- [Geographic Data Analysis and Visualization: Topics and Examples](http://geog.uoregon.edu/geogr/topics/)
- [Stack Overflow (discussion forum that includes R questions)](http://stackoverflow.com/)
- [ncss-tech Google + Group (e.g. Soil Survey R Users)](https://plus.google.com/u/0/communities/101713042265696005456)  


# References

- Ihaka, R., and R. Gentleman. 1996. R: A language for data analysis and graphics. Journal of Computational and Graphical Statistics 5(3):399–314. [https://www.stat.auckland.ac.nz/~ihaka/downloads/R-paper.pdf](https://www.stat.auckland.ac.nz/~ihaka/downloads/R-paper.pdf)  
