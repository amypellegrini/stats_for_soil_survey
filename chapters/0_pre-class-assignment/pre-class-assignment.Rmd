---
title: "Pre-course Assignment"
author: "Dylan Beaudette, Stephen Roecker, Tom D'Avello"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: no
    number_sections: yes
    toc: no
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: false
---

1. **View** Paul Finnel's [webinar](https://youtu.be/VcdowqknChQ)

2. **Create** a folder on your machine to be used as the working directory for this course at `C:\workspace`. Use all lower case letters please.

3. Open **RStudio**, and set your working directory (Session>Set Working Directory) to `C:\workspace`.

4. **Install** the necessary additional packages by **copying and pasting** the following code in the box below into the R console window after the command prompt (>) and hit **enter**. This doesn't require admin privileges. Depending on your network connection this could take a while. *Hint: the R console is the lower left or left window in RStudio with a tab labeled "Console".* If this is the first time you've installed a package, R will ask you if you want to create a local repository in your My Documents folder. Click **Yes**.

![Console](figure/rconsole.png)  

```{r, warning=FALSE, message=FALSE, results="hide", eval=FALSE}

source('https://raw.githubusercontent.com/ncss-tech/soilReports/master/R/installRprofile.R')
installRprofile()

dir.create(path="C:/workspace", recursive = TRUE)

# helper fuction for installing required packages from CRAN
# a simple check is done to see if each is already installed
# p: vector of package names
# up: logical- upgrade installed packages?
ipkCRAN <- function(p, up){
  if(up) {
    install.packages(p, dependencies = TRUE)
  } else {
    new.pkg <- p[! (p %in% installed.packages()[, "Package"])]
    if (length(new.pkg) > 0) {
      message('installing packages from CRAN...')
      install.packages(new.pkg, dependencies = TRUE)
    }
  }
}



## list of packages
packages <- c("devtools","aqp", "soilDB", "sharpshootR", "Rcpp", "clhs", "circular", "Rcmdr", "fBasics", "car", "rms", "randomForest", "rpart", "caret", "knitr", "markdown", "gdalUtils", "raster", "rgdal", "sp", "spatial", "shape", "shapefiles", "digest", "plyr", "dplyr", "httr", "reshape", "reshape2", "stringr", "stringi", "cluster", "ape", "lattice", "latticeExtra", "ggplot2", "RColorBrewer", "plotrix", "rpart.plot", "Matrix")

## install
ipkCRAN(packages, up=TRUE)

## install the latest version of packages from the AQP suite:
devtools::install_github("ncss-tech/aqp", dependencies=FALSE, upgrade_dependencies=FALSE)
devtools::install_github("ncss-tech/soilDB", dependencies=FALSE, upgrade_dependencies=FALSE)
devtools::install_github("ncss-tech/sharpshootR", dependencies=FALSE, upgrade_dependencies=FALSE)
install.packages("printr", type = "source", repos = c("http://yihui.name/xran", "http://cran.rstudio.com"))

download.file(url = "https://cran.r-project.org/bin/windows/contrib/3.2/pbkrtest_0.4-6.zip", destfile = "C:/workspace/pbkrtest_0.4-6.zip")
install.packages("C:/workspace/pbkrtest_0.4-6.zip", repos = NULL, type = "win.binary")

## load packages in the list
sapply(packages, library, character.only = TRUE, quietly = TRUE, logical.return = TRUE)
```

If the above process completed successfully, you should see two new folders on your C drive. One called **C:/R** the other called **C:/workspace**. In the C:/R/win-library/3.2 folder you should see all the packages that were installed. We installed the packages in this new library folder in order to avoid putting them in your My Documents folder, which for many USDA computers has now been redirected to a server or cloud. This will greatly increase the speed with which we are able to load and download packages. In order for R to notice the new library location, we've created the following file, "C:/workspace/.Rprofile". This is an R file designed to customize your R installation. Each time RStudio is opened it will search your default workspace location for your .Rprofile and adjust your R session according. However if RStudio is opened clicking on a file in Windows Explorer, RStudio will automatically reset your workspace to the location of the file in Windows Explorer. Therefore it is best to open R files using RStudios icons or menus. You can check the location of your R library by typing `.libPaths()` into the R console, which should say `[1] "C:/R/win-library/3.2" "C:/Program Files/R/R-3.2.1/library"`.

5. Establish an ODBC connection to NASIS by following the directions at the following hyperlink ([ODBC Connection to NASIS](http://ncss-tech.github.io/AQP/soilDB/setup_local_nasis.html)).

Once you've successfully established a ODBC connection, prove it by loading your NASIS selected set with the site and pedon tables for any user pedon id (e.g. 11CA794317), run `fetchNASIS()` in the R console like the example below, and submit your results to Tom D'Avello.

```{r example, message=FALSE, warning=FALSE, eval=FALSE}
# Example

library(soilDB)

test <- fetchNASIS()

str(test, max.level = 2)
```

6. Follow the one line example below, copy the output, and submit the results to Tom D'Avello. This should spit back a report of all the packages you downloaded.

```{r, eval=FALSE}
# Example
sessionInfo()
```

7. **IGNORE THIS STEP IT IS NOT FINISHED, PROCESS TO THE NEXT STEP** Get Example Data. Development in progress. ***this is close, review and edit as needed. I was thinking about only downloading non-ascii files...thoughts?***
After making a working directory on your local machine (`E:/r-working-dir` used as an example here), copy / paste the following code into the R console.
```{r, echo=FALSE, eval=FALSE, warning=FALSE, message=FALSE, results="hide"}
# define working dir, this should already exist
wd <- 'E:/r-working-dir'

# define function for getting files and organizing locally
getData <- function(wd, files) {
  # base data URL
  base.url <- 'https://github.com/ncss-tech/stats_for_soil_survey/blob/master/data/'
  
  # make data path using first file
  wd.data <- paste0(wd, '/', strsplit(files[1], '/')[[1]][[1]])
  
  # make a sub-folder for data files
  if(!dir.exists(wd.data))
    dir.create(wd.data)
  
  # iterate over files and download
  for(f in files) {
    f.remote <- paste0(base.url, f)
    f.local <- paste0(wd.data, '/', basename(f))
    download.file(f.remote, f.local, quiet = TRUE)
  }
}
```


8. Additional Support/Optional Readings
  - [Soil Data Aggregation using R](https://www.youtube.com/watch?v=wD9Y0Qpv5Tw)
  - [Stats for Soil Survey Webinar](https://www.youtube.com/watch?v=G5mFt9k37a4)
  - [Introduction to Stats in R](http://www.gardenersown.co.uk/Education/Lectures/R/index.htm#inputting_data)
  - [AQP Website](http://ncss-tech.github.io/AQP/)
