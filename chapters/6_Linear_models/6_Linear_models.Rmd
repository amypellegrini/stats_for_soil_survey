---
title: "6_linear_regression"
author: "Stephen Roecker, Katey Yoast"
date: "January 14, 2016"
output: 
 html_document: 
    toc: yes
---


# Introduction
Linear regression has been used for soil survey applications since the early 1900s when Briggs and McLane (1907) developed a pedotransfer function to estimate the wilting coefficient as a function of soil particle size: Wilting coefficient = 0.01(sand) + 0.12(silt) + 0.57(clay). Linear regression, as the name implys, models the linear relationship between a dependent variable (y) and an independent variable (x) where y = b0 + b1x + e (b0=intercept of the fitted line, b1=slope of the fitted line, and e= the error term). When more than one independent variable is used in the regression, the model is called multiple linear regression. In regression models, the dependent (or response) variable must always be continuous. The independent (or predictor) variable(s) can be continuous, discrete, or categorical. In order to use linear regression or any linear model, the data must be normally distributed. Most environmental data are non-linear and require transformations to the response variable (such as square root or log) for use in linear models. Often, these data are best used in non-linear models due to the complications of interpreting and predicting transformed data. Normality can be assessed in R visually using a QQ plot or histogram and tabularly using something like the Shapiro-Wilk test of normality. 

```{r load packages, message=FALSE, warning=FALSE}
library(soilDB)
library(raster)
library(rgdal)
library(lattice)
library(reshape2)
library(plyr)
library(dplyr)
library(caret)
library(fBasics)
```

# Read in data
```{r import data}
pedons <- fetchNASIS()
# pedons <- read.csv("C:workspace/pedons.csv")
```

```{r}
s <- site(pedons)
s$surface_gravel <- s$surface_gravel-s$surface_fgravel # recalculate gravel
site(pedons)$surface_total <- apply(s[, grepl("surface", names(s))], 1, sum)

idx <- complete.cases(site(pedons)[c("x", "y")]) # create an index to filter out pedons that are missing coordinates in WGS84
pedons2 <- pedons[idx]
coordinates(pedons2) <- ~ x + y # add coordinates to the pedon object
proj4string(pedons2) <- CRS("+init=epsg:4326") # add projection to pedon object
pedons_sp <- spTransform(pedons_sp, CRS("+init=epsg:5070"))

pedons_sp <- as(pedons2, "SpatialPointsDataFrame")

# Geodata extract
```{r geodata extract}
folder1 <- "M:/geodata/project_data/8VIC/"
folder2 <- "M:/geodata/imagery/gamma/"
files1 <- list(
  terrain = c(
    elev    = "ned30m_8VIC.tif",
    slope   = "ned30m_8VIC_slope5.tif",
    aspect  = "ned30m_8VIC_aspect5.tif",
    twi     = "ned30m_8VIC_wetness.tif",
    z2str   = "ned30m_8VIC_z2stream.tif",
    mrrtf   = "ned30m_8VIC_mrrtf.tif",
    mrvbf   = "ned30m_8VIC_mrvbf.tif",
    #  solar   = "ned30m_vic8_solar.tif",
    solarcv = "ned30m_vic8_solarcv.tif"
  ),
  climate = c(
    precip  = "prism30m_vic8_ppt_1981_2010_annual_mm.tif",
    precipsum = "prism30m_vic8_ppt_1981_2010_summer_mm.tif",
    temp    = "prism30m_vic8_tavg_1981_2010_annual_C.tif"
  ),
  imagery = c(
    ls = "landsat30m_vic8_b123457.tif",
    tc      = "landsat30m_vic8_tc123.tif"
  )
)
files2 <- list(
  gamma = c(
    k  = "namrad_k_aea.tif",
    th = "namrad_th_aea.tif",
    u  = "namrad_u_aea.tif"
  )
)
geodata <- c(lapply(files1, function(x) paste0(folder1, x)), lapply(files2, function(x) paste0(folder2, x))) 
names(geodata$terrain) <- names(files1$terrain)
names(geodata$climate) <- names(files1$climate)
names(geodata$imagery) <- names(files1$imagery)
names(geodata$gamma) <- names(files2$gamma)

geodata_df <- data.frame(
  as.data.frame(pedons_sp)[c("surface_total", "x_std", "y_std", "describer")],
  extract(stack(geodata$terrain[1:7]), pedons_sp),
  extract(raster(geodata$terrain[8]), pedons_sp),
  extract(stack(geodata$imagery), pedons_sp),
  extract(stack(geodata$gamma), pedons_sp),
  extract(stack(geodata$climate), pedons_sp)
)
names(geodata_df)[c(12, 18)] <- c("solarcv", "ls_7")

gidx <- list()
gidx$terrain <- names(files1$terrain)
gidx$climate <- names(files1$climate)
gidx$imagery <- names(geodata_df)[!names(geodata_df) %in% names(files1$terrain) &
                                    !names(geodata_df) %in% names(files1$climate) &
                                    !names(geodata_df) %in% names(files2$gamma) &
                                    !names(geodata_df) %in% c("x_std", "y_std", "describer", "surface_total")]
gidx$gamma <- names(files2$gamma)


data <- subset(geodata_df, select = - c(x_std, y_std))
data <- na.exclude(data)
save(data, file = "C:/workspace/stats_for_soil_survey/trunk/data/ch6_data.Rdata")

data$surface_total <- ifelse(data$mrvbf < 0.15, NA,  data$surface_total)

test2 <- lm(surface_total ~ precipsum + tc_3 + tc_2 + twi_sc + mrrtf + k + th + elev, data = data[- c(35, 506), ])

```